worker_processes auto;

events { }

stream {
  # Upstream group containing all Defguard Gateway instances
  upstream defguard_gateways {
    # Sticky sessions: the same client IP will always be routed
    # to the same backend gateway (important for WireGuard/UDP)
    hash $remote_addr consistent;

    # Backend gateways (Docker service names)
    server gateway1:50051 max_fails=2 fail_timeout=10s;
    server gateway2:50051 max_fails=2 fail_timeout=10s;
  }

  server {
    # Public UDP listener for WireGuard clients
    listen 50051 udp;

    # Forward traffic to the upstream gateways
    proxy_pass defguard_gateways;

    # Increase timeout for long-lived UDP sessions
    proxy_timeout 10m;

    # Number of expected responses per request (usually 1 for WireGuard)
    proxy_responses 1;
  }
}
